name: Build Android APK

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GRADLE_USER_HOME: ${{ github.workspace }}/.gradle

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: '11'

    - name: Set up Android SDK
      uses: android-actions/setup-android@v2
      with:
        api-level: 33
        build-tools: '33.0.2'

    - name: Accept Android SDK licenses
      run: |
        # try sdkmanager from PATH first, fall back to common SDK locations
        if command -v sdkmanager > /dev/null 2>&1; then
          yes | sdkmanager --licenses
        elif [ -d "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" ]; then
          yes | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --licenses
        elif [ -d "$ANDROID_SDK_ROOT/tools/bin" ]; then
          yes | "$ANDROID_SDK_ROOT/tools/bin/sdkmanager" --licenses
        else
          echo "sdkmanager not found; continuing (may fail later)"
        fi

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'

    - name: Install Cordova
      run: npm install -g cordova

    - name: Prepare Cordova project
      run: |
        rm -rf build-app || true
        cordova create build-app com.raybil.cityracer "CityRacer"
        # copy existing web build into Cordova www (skip if none)
        if [ -d "www" ]; then
          cp -r www/* build-app/www/ || true
        fi
        cp config.xml build-app/config.xml || true
        cd build-app
        cordova platform add android --save

    - name: Build Android APK (debug)
      run: |
        set -e
        cd build-app
        # Try Cordova build which will call Gradle; fallback if necessary
        cordova build android --debug --no-telemetry

    - name: Upload APK artifact
      uses: actions/upload-artifact@v3
      with:
        name: app-debug
        path: build-app/platforms/android/app/build/outputs/apk/debug/app-debug.apk
